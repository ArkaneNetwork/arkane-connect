name: Build
on:
  push:
    branches:
      - develop
  workflow_dispatch:
env:
  AWS_REGION: "eu-west-1"
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: 'build'
            command: 'npm run build'
          - name: 'dependencies_check'
            command: 'npm audit || true'
    permissions:
      id-token: write
      contents: write
    outputs:
      sha_tag: ${{ steps.app_info.outputs.sha_tag }}
      version_tag: ${{ steps.app_info.outputs.app_version }}
      branch_tag: ${{ steps.app_info.outputs.branch_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3.5.3
      - name: App Info
        id: app_info
        uses: ./.github/actions/app_info
        with: 
          branch: ${{ github.ref }}
      - name: Build Application
        id: build
        uses: ./.github/actions/build_node
        with:
          aws_region: ${{ env.AWS_REGION }}
          node_version_tag: 16
          command: ${{ matrix.command }}
      - name: echo output from build
        run: |
          echo "Sha Tag: ${{ steps.app_info.outputs.sha_tag }}"
          echo "Version Tag: ${{ steps.app_info.outputs.app_version }}"
          echo "Branch Tag: ${{ steps.app_info.outputs.branch_tag }}"
  docker:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: write
    strategy:
      matrix:
        microservice:
          - connect-v2
        ecr:
          - venly-connectv2-eu-west-1
        docker_context:
          - src
        include:
        - service: connect-v2
          ecr: venly-connectv2-eu-west-1
          docker_context: src
    steps:
      - name: build-and-deploy-docker
        if: ${{ success() && (github.ref_name == 'main'  || github.ref_name == 'master' || github.ref_name == 'develop' || github.ref_name == 'release-*' || github.ref_name == 'hotfix-*' || github.ref_name == 'VLDEVOPS-135-update-ecs-deploys') }}
        id: build-deploy-docker
        uses: ./.github/actions/build_docker
        with:
          aws_role: ${{ secrets.RESOURCES_DEPLOY_ROLE }}
          docker_context: ${{ matrix.docker_context }}
          ecr_repo: ${{ matrix.ecr }}
          sha_tag: ${{ needs.build.outputs.sha_tag }}
          version_tag: ${{ needs.build.outputs.version_tag }}
          branch_tag: ${{ needs.build.outputs.branch_tag }}
          push_image: false
